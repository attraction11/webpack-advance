(function(e){e.fn.wPaint=function(h,g){if(typeof h==="object"){g=h}else{if(typeof h=="string"){var f=[];var i=this.each(function(){var j=e(this).data("_wPaint");if(j){if(h=="clear"){j.clearAll()}else{if(h=="image"&&g===undefined){f.push(j.getImage())}else{if(h=="image"&&g!==undefined){j.setImage(g,true)}else{if(h=="imageBg"&&g!==undefined){j.setBgImage(g)}else{if(e.fn.wPaint.defaultSettings[h]!==undefined){if(g!==undefined){j.settings[h]=g}else{f.push(j.settings[h])}}}}}}}});if(f.length===1){return f[0]}if(f.length>0){return f}else{return i}}}g=e.extend({},e.fn.wPaint.defaultSettings,g||{});g.lineWidthMin=parseInt(g.lineWidthMin);g.lineWidthMax=parseInt(g.lineWidthMax);g.lineWidth=parseInt(g.lineWidth);g.fontSizeMin=parseInt(g.fontSizeMin);g.fontSizeMax=parseInt(g.fontSizeMax);g.fontSize=parseInt(g.fontSize);return this.each(function(){var k=e(this);var m=jQuery.extend(true,{},g);var n=document.createElement("canvas");if(!n.getContext){k.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser.");return false}if(k.data("_wPaint")){return false}var l=new a(m,k);l.mainMenu=new d(l);l.textMenu=new c(l);if(m.imageBg){k.append(l.generateBg(k.width(),k.height(),m.imageBg))}k.append(l.generate(k.width(),k.height()));k.append(l.generateTemp());k.append(l.generateTextInput());k.append(l.mainMenu.generate(l,l.textMenu)).append(l.textMenu.generate(l,l.mainMenu));l.mainMenu.moveTextMenu(l.mainMenu,l.textMenu);l.mainMenu.set_mode(l.mainMenu,l,m.mode);var j=e("._wPaint_icon").outerHeight(true)-(parseInt(e("._wPaint_icon").css("paddingTop").split("px")[0])+parseInt(e("._wPaint_icon").css("paddingBottom").split("px")[0]));l.mainMenu.menu.find("._wPaint_fillColorPicker").wColorPicker({mode:"click",initColor:m.fillStyle,buttonSize:j,showSpeed:300,hideSpeed:300,onSelect:function(o){l.settings.fillStyle=o;l.textInput.css({color:o})}});l.mainMenu.menu.find("._wPaint_strokeColorPicker").wColorPicker({mode:"click",initColor:m.strokeStyle,buttonSize:j,showSpeed:300,hideSpeed:300,onSelect:function(o){l.settings.strokeStyle=o}});l.mainMenu.setWidth(l,l.mainMenu.menu);l.mainMenu.setWidth(l,l.textMenu.menu);if(m.image){l.setImage(m.image,true)}else{l.addUndo()}k.data("_wPaint",l)})};var b=["Rectangle","Ellipse","Line","Text"];e.fn.wPaint.defaultSettings={mode:"Pencil",lineWidthMin:"0",lineWidthMax:"10",lineWidth:"2",fillStyle:"transparent",strokeStyle:"#FF0000",fontSizeMin:"8",fontSizeMax:"20",fontSize:"12",fontFamilyOptions:["Arial","Courier","Times","Trebuchet","Verdana"],fontFamily:"Arial",fontTypeBold:false,fontTypeItalic:false,fontTypeUnderline:false,image:null,imageBg:null,drawDown:null,drawMove:null,drawUp:null,menu:["undo","redo","clear","rectangle","ellipse","line","pencil","text","eraser","fillColor","lineWidth","strokeColor"],menuOrientation:"horizontal",menuOffsetX:5,menuOffsetY:5,menuTitles:{"undo":"undo","redo":"redo","clear":"clear","rectangle":"rectangle","ellipse":"ellipse","line":"line","pencil":"pencil","text":"text","eraser":"eraser","fillColor":"fill color","lineWidth":"line width","strokeColor":"stroke color","bold":"bold","italic":"italic","underline":"underline","fontSize":"font size","fontFamily":"font family"},disableMobileDefaults:false};function a(f,g){this.settings=f;this.$elem=g;this.mainMenu=null;this.textMenu=null;this.undoArray=[];this.undoCurrent=-1;this.undoMax=10;this.draw=false;this.canvas=null;this.ctx=null;this.canvasTemp=null;this.ctxTemp=null;this.canvasBg=null;this.ctxBg=null;this.canvasTempLeftOriginal=null;this.canvasTempTopOriginal=null;this.canvasTempLeftNew=null;this.canvasTempTopNew=null;this.textInput=null;return this}a.prototype={generate:function(h,g){this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");var f=this;e(this.canvas).attr("width",h+"px").attr("height",g+"px").css({position:"absolute",left:0,top:0}).mousedown(function(i){i.preventDefault();i.stopPropagation();f.draw=true;f.callFunc(i,f,"Down")});e(document).mousemove(function(i){if(f.draw){f.callFunc(i,f,"Move")}}).mouseup(function(i){if(f.draw){f.draw=false;f.callFunc(i,f,"Up")}});this.bindMobile();return e(this.canvas)},bindMobile:function(){e(this.canvas).bind("touchstart touchmove touchend touchcancel",function(){var h=event.changedTouches,i=h[0],f="";switch(event.type){case"touchstart":f="mousedown";break;case"touchmove":f="mousemove";break;case"touchend":f="mouseup";break;default:return}var g=document.createEvent("MouseEvent");g.initMouseEvent(f,true,true,window,1,i.screenX,i.screenY,i.clientX,i.clientY,false,false,false,false,0,null);i.target.dispatchEvent(g);event.preventDefault()});if(this.settings.disableMobileDefaults){e(document).bind("touchmove",function(f){f.preventDefault()})}},generateTemp:function(){this.canvasTemp=document.createElement("canvas");this.ctxTemp=this.canvasTemp.getContext("2d");e(this.canvasTemp).css({position:"absolute"}).hide();return e(this.canvasTemp)},generateBg:function(h,g,i){var f=this;if(!this.canvasBg){this.canvasBg=document.createElement("canvas");
this.ctxBg=this.canvasBg.getContext("2d");e(this.canvasBg).attr("id","mofo").css({position:"absolute",left:0,top:0}).attr("width",h).attr("height",g)}this.setBgImage(i);return e(this.canvasBg)},generateTextInput:function(){var f=this;f.textCalc=e("<div></div>").css({display:"none",fontSize:this.settings.fontSize,lineHeight:this.settings.fontSize+"px",fontFamily:this.settings.fontFamily});f.textInput=e('<textarea class="_wPaint_textInput" spellcheck="false"></textarea>').css({display:"none",position:"absolute",color:this.settings.fillStyle,fontSize:this.settings.fontSize,lineHeight:this.settings.fontSize+"px",fontFamily:this.settings.fontFamily});if(f.settings.fontTypeBold){f.textInput.css("fontWeight","bold");f.textCalc.css("fontWeight","bold")}if(f.settings.fontTypeItalic){f.textInput.css("fontStyle","italic");f.textCalc.css("fontStyle","italic")}if(f.settings.fontTypeUnderline){f.textInput.css("textDecoration","underline");f.textCalc.css("textDecoration","underline")}e("body").append(f.textCalc);return f.textInput},callFunc:function(j,f,i){$e=jQuery.extend(true,{},j);var g=e(f.canvas).offset();$e.pageX=Math.floor($e.pageX-g.left);$e.pageY=Math.floor($e.pageY-g.top);var k=e.inArray(f.settings.mode,b)>-1?"Shape":f.settings.mode;var h=f["draw"+k+""+i];if(h){h($e,f)}if(f.settings["draw"+i]){f.settings["draw"+i].apply(f,[j,k])}if(f.settings.mode!=="Text"&&i==="Up"){this.addUndo()}},drawShapeDown:function(h,f){if(f.settings.mode=="Text"){if(f.textInput.val()!=""){f.drawTextUp(h,f)}f.textInput.css({left:h.pageX-1,top:h.pageY-1,width:0,height:0})}e(f.canvasTemp).css({left:h.pageX,top:h.pageY}).attr("width",0).attr("height",0).show();f.canvasTempLeftOriginal=h.pageX;f.canvasTempTopOriginal=h.pageY;var g=f["draw"+f.settings.mode+"Down"];if(g){g(h,f)}},drawShapeMove:function(l,n){var j=n.canvasTempLeftOriginal;var f=n.canvasTempTopOriginal;var k=n.settings.lineWidth/2;var i=(l.pageX<j?l.pageX:j)-(n.settings.mode=="Line"?Math.floor(k):0);var o=(l.pageY<f?l.pageY:f)-(n.settings.mode=="Line"?Math.floor(k):0);var g=Math.abs(l.pageX-j)+(n.settings.mode=="Line"?n.settings.lineWidth:0);var p=Math.abs(l.pageY-f)+(n.settings.mode=="Line"?n.settings.lineWidth:0);e(n.canvasTemp).css({left:i,top:o}).attr("width",g).attr("height",p);if(n.settings.mode=="Text"){n.textInput.css({left:i-1,top:o-1,width:g,height:p})}n.canvasTempLeftNew=i;n.canvasTempTopNew=o;var h=n["draw"+n.settings.mode+"Move"];if(h){var m=n.settings.mode=="Line"?1:2;l.x=k*m;l.y=k*m;l.w=g-n.settings.lineWidth*m;l.h=p-n.settings.lineWidth*m;n.ctxTemp.fillStyle=n.settings.fillStyle;n.ctxTemp.strokeStyle=n.settings.strokeStyle;n.ctxTemp.lineWidth=n.settings.lineWidth*m;h(l,n)}},drawShapeUp:function(h,f){if(f.settings.mode!="Text"){f.ctx.drawImage(f.canvasTemp,f.canvasTempLeftNew,f.canvasTempTopNew);e(f.canvasTemp).hide();var g=f["draw"+f.settings.mode+"Up"];if(g){g(h,f)}}},drawRectangleMove:function(g,f){f.ctxTemp.beginPath();f.ctxTemp.rect(g.x,g.y,g.w,g.h);f.ctxTemp.closePath();f.ctxTemp.stroke();f.ctxTemp.fill()},drawEllipseMove:function(l,m){var k=0.5522848;var h=(l.w/2)*k;var f=(l.h/2)*k;var n=l.x+l.w;var j=l.y+l.h;var i=l.x+l.w/2;var g=l.y+l.h/2;m.ctxTemp.beginPath();m.ctxTemp.moveTo(l.x,g);m.ctxTemp.bezierCurveTo(l.x,g-f,i-h,l.y,i,l.y);m.ctxTemp.bezierCurveTo(i+h,l.y,n,g-f,n,g);m.ctxTemp.bezierCurveTo(n,g+f,i+h,j,i,j);m.ctxTemp.bezierCurveTo(i-h,j,l.x,g+f,l.x,g);m.ctxTemp.closePath();if(m.settings.lineWidth>0){m.ctxTemp.stroke()}m.ctxTemp.fill()},drawLineMove:function(h,f){var g=f.canvasTempLeftOriginal;var i=f.canvasTempTopOriginal;if(h.pageX<g){h.x=h.x+h.w;h.w=h.w*-1}if(h.pageY<i){h.y=h.y+h.h;h.h=h.h*-1}f.ctxTemp.lineJoin="round";f.ctxTemp.beginPath();f.ctxTemp.moveTo(h.x,h.y);f.ctxTemp.lineTo(h.x+h.w,h.y+h.h);f.ctxTemp.closePath();f.ctxTemp.stroke()},drawPencilDown:function(g,f){f.ctx.lineJoin="round";f.ctx.lineCap="round";f.ctx.strokeStyle=f.settings.strokeStyle;f.ctx.fillStyle=f.settings.strokeStyle;f.ctx.lineWidth=f.settings.lineWidth;f.ctx.beginPath();f.ctx.arc(g.pageX,g.pageY,f.settings.lineWidth/2,0,Math.PI*2,true);f.ctx.closePath();f.ctx.fill();f.ctx.beginPath();f.ctx.moveTo(g.pageX,g.pageY)},drawPencilMove:function(g,f){f.ctx.lineTo(g.pageX,g.pageY);f.ctx.stroke()},drawPencilUp:function(g,f){f.ctx.closePath()},drawTextDown:function(g,f){f.textInput.val("").show().focus()},drawTextUp:function(r,t){if(r){this.addUndo()}var v="";if(t.settings.fontTypeItalic){v+="italic "}if(t.settings.fontTypeBold){v+="bold "}v+=t.settings.fontSize+"px "+t.settings.fontFamily;var x=t.textInput.val().split("\n");var h=[];var s=t.textInput.width()-2;var g=0;var l=0;for(var p=0,w=x.length;p<w;p++){t.textCalc.html("");l=0;for(var n=0,q=x[0].length;n<q;n++){g=t.textCalc.append(x[p][n]).width();if(g>s){h.push(x[p].substring(l,n));l=n;t.textCalc.html(x[p][n])}}if(l!=n){h.push(x[p].substring(l,n))}}x=t.textInput.val(h.join("\n")).val().split("\n");var m=t.textInput.position();var k=m.left;var u=m.top;var o=0;for(var p=0,w=x.length;p<w;p++){t.ctx.fillStyle=t.settings.fillStyle;t.ctx.textBaseline="top";
t.ctx.font=v;t.ctx.fillText(x[p],k,u);u+=t.settings.fontSize;if(x[p]!=""&&t.settings.fontTypeUnderline){g=t.textCalc.html(x[p]).width();var f=t.ctx.getImageData(0,u+o,g,1);for(n=0;n<f.width*f.height*4;n+=4){f.data[n]=parseInt(t.settings.fillStyle.substring(1,3),16);f.data[n+1]=parseInt(t.settings.fillStyle.substring(3,5),16);f.data[n+2]=parseInt(t.settings.fillStyle.substring(5,7),16);f.data[n+3]=255}t.ctx.putImageData(f,k,u+o)}}},drawEraserDown:function(g,f){f.ctx.save();f.ctx.globalCompositeOperation="destination-out";f.drawPencilDown(g,f)},drawEraserMove:function(g,f){f.drawPencilMove(g,f)},drawEraserUp:function(g,f){f.drawPencilUp(g,f);f.ctx.restore()},getImage:function(){this.canvasSave=document.createElement("canvas");this.ctxSave=this.canvasSave.getContext("2d");e(this.canvasSave).css({display:"none",position:"absolute",left:0,top:0}).attr("width",e(this.canvas).attr("width")).attr("height",e(this.canvas).attr("height"));if(this.canvasBg){this.ctxSave.drawImage(this.canvasBg,0,0)}this.ctxSave.drawImage(this.canvas,0,0);return this.canvasSave.toDataURL()},setImage:function(i,g){var f=this;var h=new Image();h.src=i.toString();f.ctx.clearRect(0,0,f.canvas.width,f.canvas.height);e(h).on('load', function(){f.ctx.drawImage(h,0,0);if(g){f.addUndo()}})},setBgImage:function(i,g){var f=this;var h=new Image();h.src=i.toString();f.ctxBg.clearRect(0,0,f.canvasBg.width,f.canvasBg.height);e(h).on('load', function(){f.ctxBg.drawImage(h,0,0)})},addUndo:function(){if(this.undoCurrent<this.undoArray.length-1){this.undoArray[++this.undoCurrent]=this.getImage()}else{this.undoArray.push(this.getImage());if(this.undoArray.length>this.undoMax){this.undoArray=this.undoArray.slice(1,this.undoArray.length)}else{this.undoCurrent++}}while(this.undoCurrent!=this.undoArray.length-1){this.undoArray.pop()}this.undoToggleIcons()},setUndoImage:function(){this.setImage(this.undoArray[this.undoCurrent])},undoNext:function(){if(this.undoArray[this.undoCurrent+1]){this.undoCurrent++;this.setUndoImage()}this.undoToggleIcons()},undoPrev:function(){if(this.undoArray[this.undoCurrent-1]){this.undoCurrent--;this.setUndoImage()}this.undoToggleIcons()},undoToggleIcons:function(){var f=this.mainMenu.menu.find("._wPaint_undo");var g=this.mainMenu.menu.find("._wPaint_redo");if(this.undoCurrent>0&&this.undoArray.length>1){if(!f.hasClass("uactive")){f.addClass("uactive")}}else{f.removeClass("uactive")}if(this.undoCurrent<this.undoArray.length-1){if(!g.hasClass("uactive")){g.addClass("uactive")}}else{g.removeClass("uactive")}},clearAll:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.addUndo()}};function d(f){this.menu=null;return this}d.prototype={generate:function(f,g){var l=f;this.textMenu=g;var k=this;var o="";for(var h=l.settings.lineWidthMin;h<=l.settings.lineWidthMax;h++){o+='<option value="'+h+'" '+(l.settings.lineWidth==h?'selected="selected"':"")+">"+h+"</option>"}var j=e('<div class="_wPaint_lineWidth _wPaint_dropDown" title="'+l.settings.menuTitles.lineWidth+'"></div>').append(e("<select>"+o+"</select>").change(function(i){l.settings.lineWidth=parseInt(e(this).val())}));var n=e('<div class="_wPaint_options"></div>');e.each(l.settings.menu,function(p,q){switch(q){case"undo":n.append(e('<div class="_wPaint_icon _wPaint_undo" title="'+l.settings.menuTitles.undo+'"></div>').click(function(){l.undoPrev()}));break;case"redo":n.append(e('<div class="_wPaint_icon _wPaint_redo" title="'+l.settings.menuTitles.redo+'"></div>').click(function(){l.undoNext()}));break;case"clear":n.append(e('<div class="_wPaint_icon _wPaint_clear" title="'+l.settings.menuTitles.clear+'"></div>').click(function(){l.clearAll()}));break;case"rectangle":n.append(e('<div class="_wPaint_icon _wPaint_rectangle" title="'+l.settings.menuTitles.rectangle+'"></div>').click(function(){k.set_mode(k,l,"Rectangle")}));break;case"ellipse":n.append(e('<div class="_wPaint_icon _wPaint_ellipse" title="'+l.settings.menuTitles.ellipse+'"></div>').click(function(){k.set_mode(k,l,"Ellipse")}));break;case"line":n.append(e('<div class="_wPaint_icon _wPaint_line" title="'+l.settings.menuTitles.line+'"></div>').click(function(){k.set_mode(k,l,"Line")}));break;case"pencil":n.append(e('<div class="_wPaint_icon _wPaint_pencil" title="'+l.settings.menuTitles.pencil+'"></div>').click(function(){k.set_mode(k,l,"Pencil")}));break;case"text":n.append(e('<div class="_wPaint_icon _wPaint_text" title="'+l.settings.menuTitles.text+'"></div>').click(function(){k.set_mode(k,l,"Text")}));break;case"eraser":n.append(e('<div class="_wPaint_icon _wPaint_eraser" title="'+l.settings.menuTitles.eraser+'"></div>').click(function(i){k.set_mode(k,l,"Eraser")}));break;case"fillColor":n.append(e('<div class="_wPaint_fillColorPicker _wPaint_colorPicker" title="'+l.settings.menuTitles.fillColor+'"></div>'));break;case"lineWidth":n.append(j);break;case"strokeColor":n.append(e('<div class="_wPaint_strokeColorPicker _wPaint_colorPicker" title="'+l.settings.menuTitles.strokeColor+'r"></div>'));break}});var m=e('<div class="_wPaint_handle"></div>');
return this.menu=e('<div class="_wPaint_menu _wPaint_menu_'+l.settings.menuOrientation+'"></div>').css({position:"absolute",left:l.settings.menuOffsetX,top:l.settings.menuOffsetY}).draggable({handle:m,drag:function(){k.moveTextMenu(k,k.textMenu)},stop:function(){k.moveTextMenu(k,k.textMenu)}}).append(m).append(n)},moveTextMenu:function(g,f){if(f.docked){f.menu.css({left:parseInt(g.menu.css("left"))+f.dockOffsetLeft,top:parseInt(g.menu.css("top"))+f.dockOffsetTop})}},set_mode:function(f,g,h){g.settings.mode=h;if(h=="Text"){f.textMenu.menu.show();f.setWidth(g,f.textMenu.menu)}else{g.drawTextUp(null,g);f.textMenu.menu.hide();g.textInput.hide()}f.menu.find("._wPaint_icon").removeClass("active");f.menu.find("._wPaint_"+h.toLowerCase()).addClass("active")},setWidth:function(g,i){var f=i.find("._wPaint_options");if(g.settings.menuOrientation==="vertical"){var h=i.find("._wPaint_options > div:first").outerWidth(true);h+=(f.outerWidth(true)-f.width())}else{var h=i.find("._wPaint_handle").outerWidth(true);h+=i.outerWidth(true)-i.width();i.find("._wPaint_options").children().each(function(){h+=e(this).outerWidth(true)})}i.width(h)}};function c(f){this.menu=null;this.docked=true;this.dockOffsetLeft=f.settings.menuOrientation==="vertical"?36:0;this.dockOffsetTop=f.settings.menuOrientation==="vertical"?0:36;return this}c.prototype={generate:function(g,f){var m=g;var l=this;var r="";for(var j=m.settings.fontSizeMin;j<=m.settings.fontSizeMax;j++){r+='<option value="'+j+'" '+(m.settings.fontSize==j?'selected="selected"':"")+">"+j+"</option>"}var q=e('<div class="_wPaint_fontSize _wPaint_dropDown" title="'+m.settings.menuTitles.fontSize+'"></div>').append(e("<select>"+r+"</select>").change(function(s){var i=parseInt(e(this).val());m.settings.fontSize=i;m.textInput.css({fontSize:i,lineHeight:i+"px"});m.textCalc.css({fontSize:i,lineHeight:i+"px"})}));var r="";for(var j=0,p=m.settings.fontFamilyOptions.length;j<p;j++){r+='<option value="'+m.settings.fontFamilyOptions[j]+'" '+(m.settings.fontFamily==m.settings.fontFamilyOptions[j]?'selected="selected"':"")+">"+m.settings.fontFamilyOptions[j]+"</option>"}var k=e('<div class="_wPaint_fontFamily _wPaint_dropDown" title="'+m.settings.menuTitles.fontFamily+'"><div class="_wPaint_dropDown_cover"></div></div>').append(e("<select>"+r+"</select>").change(function(s){var i=e(this).val();m.settings.fontFamily=i;m.textInput.css({fontFamily:i});m.textCalc.css({fontFamily:i})}));var o=e('<div class="_wPaint_options"></div>').append(e('<div class="_wPaint_icon _wPaint_bold '+(m.settings.fontTypeBold?"active":"")+'" title="'+m.settings.menuTitles.bold+'"></div>').click(function(){l.setType(l,m,"Bold")})).append(e('<div class="_wPaint_icon _wPaint_italic '+(m.settings.fontTypeItalic?"active":"")+'" title="'+m.settings.menuTitles.italic+'"></div>').click(function(){l.setType(l,m,"Italic")})).append(e('<div class="_wPaint_icon _wPaint_underline '+(m.settings.fontTypeUnderline?"active":"")+'" title="'+m.settings.menuTitles.underline+'"></div>').click(function(){l.setType(l,m,"Underline")})).append(q).append(k);var n=e('<div class="_wPaint_handle"></div>');var h=e(m.canvas).offset();return this.menu=e('<div class="_wPaint_menu _wPaint_menu_'+m.settings.menuOrientation+'""></div>').css({display:"none",position:"absolute"}).draggable({snap:"",handle:n,stop:function(){e.each(e(this).data("draggable").snapElements,function(i,s){l.dockOffsetLeft=l.menu.offset().left-f.menu.offset().left;l.dockOffsetTop=l.menu.offset().top-f.menu.offset().top;l.docked=s.snapping})}}).append(n).append(o)},setType:function(f,i,j){var g=f.menu.find("._wPaint_"+j.toLowerCase());var h=g.hasClass("active");i.settings["fontType"+j]=!h;h?g.removeClass("active"):g.addClass("active");fontTypeBold=i.settings.fontTypeBold?"bold":"normal";fontTypeItalic=i.settings.fontTypeItalic?"italic":"normal";fontTypeUnderline=i.settings.fontTypeUnderline?"underline":"none";i.textInput.css({fontWeight:fontTypeBold});i.textCalc.css({fontWeight:fontTypeBold});i.textInput.css({fontStyle:fontTypeItalic});i.textCalc.css({fontStyle:fontTypeItalic});i.textInput.css({textDecoration:fontTypeUnderline});i.textCalc.css({textDecoration:fontTypeUnderline})}}})(jQuery);